<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Visualización de la Red SDN</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    svg { border: 1px solid black; }
    .link { stroke: #999; stroke-width: 2px; }
    .node { fill: steelblue; stroke: white; stroke-width: 2px; cursor: pointer; }
    .highlight { stroke: red; stroke-width: 4px; }
  </style>
</head>
<body>
  <h2>Visualización de la Red SDN</h2>

  <div id="snapshot-counter" style="font-weight: bold; font-size: 16px; margin-bottom: 10px;">
    Instantánea: 0
  </div>
  
  <svg width="600" height="400"></svg>

  <script>
    const socket = io.connect('http://127.0.0.1:5000');
    const svg = d3.select("svg");
    let nodes = [];
    let links = [];
    let linkElements, nodeElements, labelElements;
    let simulation;

    function initializeNetwork(data) {
      nodes = data.switches.map(d => ({ id: d }));
      let nodeMap = new Map(nodes.map(n => [n.id, n]));

      links = data.links.map(l => ({
        source: nodeMap.get(l.src),
        target: nodeMap.get(l.dst),
        load: l.load,
        delay: l.delay,
        packet_loss: l.packet_loss
      }));

      simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(100))
        .force("charge", d3.forceManyBody().strength(-400))
        .force("center", d3.forceCenter(300, 200));

      linkElements = svg.selectAll(".link")
        .data(links)
        .enter().append("line")
        .attr("class", "link")
        .attr("stroke-width", d => d.load * 10);

      nodeElements = svg.selectAll(".node")
        .data(nodes)
        .enter().append("circle")
        .attr("class", "node")
        .attr("r", 20);

      labelElements = svg.selectAll(".label")
        .data(nodes)
        .enter().append("text")
        .attr("class", "label")
        .text(d => d.id)
        .attr("font-size", 14)
        .attr("dx", 25)
        .attr("dy", 5);

      simulation.on("tick", () => {
        linkElements
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);

        nodeElements
          .attr("cx", d => d.x)
          .attr("cy", d => d.y);

        labelElements
          .attr("x", d => d.x)
          .attr("y", d => d.y);
      });
    }

    function highlightBestPath(bestPath) {
      if (!bestPath || bestPath.length === 0) return;

      const pathSet = new Set(bestPath.map(String));  // Convertir todo a strings

      linkElements.classed("highlight", d => {
        const srcId = d.source.id.toString();
        const dstId = d.target.id.toString();

        const idxSource = bestPath.indexOf(srcId);
        const idxTarget = bestPath.indexOf(dstId);

        return idxSource !== -1 && idxTarget !== -1 && Math.abs(idxSource - idxTarget) === 1;
      });
    }


    socket.on('update_topology', function(data) {
      highlightBestPath(data.best_path.map(x => x.toString()));  // Asegurarse que IDs son strings
    });

    fetch('/topology')
      .then(response => response.json())
      .then(data => {
        initializeNetwork(data);
      });
  </script>

</body>
</html>
